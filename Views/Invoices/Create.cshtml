@using InvoiceManagementSystem.ViewModels
@model InvoiceCreateVm
@{
    Layout = "_Layout";
    ViewData["Title"] = "Crear Nueva Factura";
}

<div class="container-fluid py-4">
    <div class="text-center mb-4">
        <h1 class="display-4 fw-bold">DATOS DE LA COMPRA</h1>
        <hr class="border border-dark border-2 opacity-75" />
    </div>

    <div class="card shadow-lg border-0">
        <div class="card-body p-4">
            <form id="invoiceForm" method="post" asp-action="Create">

                <div class="card border-primary mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-person-circle"></i> Datos del Cliente</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="fw-bold mb-2">Buscar Cliente Por:</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-primary" id="btnSearchById">
                                    <i class="bi bi-hash"></i> ID
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="btnSearchByName">
                                    <i class="bi bi-person"></i> Nombre
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="btnSearchByLastName">
                                    <i class="bi bi-person-badge"></i> Apellido
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="btnSearchByEmail">
                                    <i class="bi bi-envelope"></i> Email
                                </button>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-3 position-relative">
                                <label class="form-label fw-bold">ID Cliente</label>
                                <input type="text" id="searchCustomerId" class="form-control" placeholder="Ej: 5" disabled />
                                <div id="customerIdResults" class="search-dropdown"></div>
                            </div>
                            <div class="col-md-3 position-relative">
                                <label class="form-label fw-bold">Nombre</label>
                                <input type="text" id="searchCustomerName" class="form-control" placeholder="Ej: Juan" disabled />
                                <div id="customerNameResults" class="search-dropdown"></div>
                            </div>
                            <div class="col-md-3 position-relative">
                                <label class="form-label fw-bold">Apellido</label>
                                <input type="text" id="searchCustomerLastName" class="form-control" placeholder="Ej: Pérez" disabled />
                                <div id="customerLastNameResults" class="search-dropdown"></div>
                            </div>
                            <div class="col-md-3 position-relative">
                                <label class="form-label fw-bold">Email</label>
                                <input type="text" id="searchCustomerEmail" class="form-control" placeholder="Ej: juan@email.com" disabled />
                                <div id="customerEmailResults" class="search-dropdown"></div>
                            </div>
                        </div>

                        <div class="card bg-light p-3" id="selectedCustomerCard" style="display:none;">
                            <h6 class="text-success mb-3"><i class="bi bi-check-circle"></i> Cliente Seleccionado</h6>
                            <div class="row">
                                <div class="col-md-2">
                                    <strong>ID:</strong>
                                    <p id="displayCustomerId" class="mb-0">-</p>
                                    <input type="hidden" id="CustomerID" name="CustomerID" />
                                </div>
                                <div class="col-md-3">
                                    <strong>Nombre:</strong>
                                    <p id="displayFirstName" class="mb-0">-</p>
                                    <input type="hidden" id="FirstName" />
                                </div>
                                <div class="col-md-3">
                                    <strong>Apellido:</strong>
                                    <p id="displayLastName" class="mb-0">-</p>
                                    <input type="hidden" id="LastName" />
                                </div>
                                <div class="col-md-4">
                                    <strong>Email:</strong>
                                    <p id="displayEmail" class="mb-0">-</p>
                                    <input type="hidden" id="Email" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-success mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-box-seam"></i> Información del Producto</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="fw-bold mb-2">Buscar Producto Por:</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-success" id="btnSearchByCode">
                                    <i class="bi bi-upc-scan"></i> Código
                                </button>
                                <button type="button" class="btn btn-outline-success" id="btnSearchByProductName">
                                    <i class="bi bi-tag"></i> Nombre
                                </button>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-2 position-relative">
                                <label class="form-label fw-bold">Código</label>
                                <input type="text" id="searchProductCode" class="form-control" placeholder="LAP-001" disabled />
                                <div id="productCodeResults" class="search-dropdown"></div>
                            </div>
                            <div class="col-md-4 position-relative">
                                <label class="form-label fw-bold">Nombre</label>
                                <input type="text" id="searchProductName" class="form-control" placeholder="Laptop Dell..." disabled />
                                <div id="productNameResults" class="search-dropdown"></div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Precio</label>
                                <input type="text" id="ProductPrice" class="form-control" readonly />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Stock</label>
                                <input type="text" id="ProductStock" class="form-control text-danger fw-bold" readonly />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold text-primary">Cantidad *</label>
                                <input type="number" id="ProductQuantity" class="form-control" min="1" value="1" disabled />
                            </div>
                        </div>

                        <div class="text-end mb-3">
                            <button type="button" id="btnAddProduct" class="btn btn-success btn-lg" disabled>
                                <i class="bi bi-plus-circle"></i> AGREGAR A FACTURA
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="productsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-end">Precio Unit.</th>
                                        <th class="text-end">Total</th>
                                        <th class="text-center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <tr id="emptyRow">
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="bi bi-inbox fs-1"></i>
                                            <p class="mb-0">No hay productos agregados</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12 text-center mb-4">
                        <button type="button" id="btnGenerateInvoice" class="btn btn-primary btn-lg px-5 py-3" disabled>
                            <i class="bi bi-file-earmark-text fs-4"></i>
                            <span class="fs-5 ms-2">GENERAR FACTURA</span>
                        </button>
                    </div>
                </div>

                <div class="card border-success" id="invoicePreview" style="display:none;">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">✅ Vista Previa de la Factura</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>📝 Nota:</strong> Al confirmar, la factura se abrirá en una nueva ventana y se generará automáticamente el número de factura.
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h5><strong>Número de Factura:</strong></h5>
                                <p class="fs-5 text-success">(Se generará automáticamente)</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <h5><strong>Fecha:</strong></h5>
                                <p class="fs-5">@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</p>
                            </div>
                        </div>

                        <hr />

                        <table class="table table-borderless">
                            <tr>
                                <td class="text-start fw-bold fs-5">Subtotal:</td>
                                <td class="text-end fs-5" id="subtotalAmount">$0.00</td>
                            </tr>
                            <tr>
                                <td class="text-start fw-bold fs-5">IVA (19%):</td>
                                <td class="text-end fs-5" id="taxAmount">$0.00</td>
                            </tr>
                            <tr class="border-top border-3 border-dark">
                                <td class="text-start fw-bold fs-3">TOTAL:</td>
                                <td class="text-end fw-bold fs-3 text-success" id="totalAmount">$0.00</td>
                            </tr>
                        </table>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-success btn-lg px-5">
                                <i class="bi bi-check-circle"></i> CONFIRMAR Y CREAR FACTURA
                            </button>
                        </div>
                    </div>
                </div>

                <input type="hidden" id="detailsJson" name="DetailsJson" />
            </form>
        </div>
    </div>
</div>

<style>
    .position-relative {
        position: relative;
    }

    .search-dropdown {
        position: absolute;
        z-index: 1050;
        background: white;
        border: 2px solid #0d6efd;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        width: 100%;
        margin-top: 5px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        display: none;
        left: 0;
        top: 100%; /* Esta línea asegura que el dropdown aparezca justo debajo del input */
    }

    .search-result-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s;
    }

        .search-result-item:hover {
            background-color: #e7f3ff;
            border-left: 4px solid #0d6efd;
        }

        .search-result-item strong {
            color: #0d6efd;
        }

    .btn-group .btn {
        flex: 1;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/invoice-advanced.js"></script>